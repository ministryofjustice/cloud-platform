---
title: Template for Cloud Platform Disaster Recovery run-books
weight: 8000
last_reviewed_on: 2019-02-27
review_in: 3 months
---

# Template for Disaster Recovery run-books

This is a template for writing run-books for other Disaster Recovery scenarios. 

## Disaster scenario

Disaster scenario "cluster deleted", where a cluster has been accidentally deleted by running `kops delete cluster`.


## Restore process

To restore the cluster, start with [creating a new cluster][create-a-new-cluster] and [perform the restore][perform-the-restore] using etcd backup.


### Create a new cluster

Use `kops` to create the cluster using "kops/${CLUSTER_NAME}.yaml" in [here][kops-repo].


Set environment variables.

```bash
$ export KOPS_STATE_STORE=s3://cloud-platform-kops-state
$ export CLUSTER_NAME=${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk
```

Run kops command to create the cluster

```
kops create -f ../../kops/${CLUSTER_NAME}.yaml
```

```
kops update cluster ${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk --yes
```

```
kops validate cluster
```

Once it reports Your cluster `${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk is ready` you can proceed to use kubectl to interact with the cluster.

### Perform the restore

When we have a working cluster (kops validate cluster should show cluster in ready status), then restore cluster back to the point before disaster occurred using backup stored in 's3://cloud-platform-kops-state/${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk/backups, by running etcd-manager-ctl.

#### Pre-requisites

Install  kops-manager-ctl in your workstation. Run the below command by updating the latest [release][etcd-managet-ctl] version available for etcd-manager-ctl.

```
  curl -Lo etcd-manager-ctl  https://github.com/kopeio/etcd-manager/releases/download/3.0.20190816/etcd-manager-ctl-darwin-amd64 && chmod +x etcd-manager-ctl && mv etcd-manager-ctl /usr/local/bin
```

#### Restore from backup

Run the below commands, to list the backups for main and events. We are listing backups for the cluster named `test-etcd-3.cloud-platform.service.justice.gov.uk` in a S3 bucket called `cloud-platform-kops-state`.

```
etcd-manager-ctl --backup-store=s3://cloud-platform-kops-state/test-etcd-3.cloud-platform.service.justice.gov.uk/backups/etcd/main list-backups
etcd-manager-ctl --backup-store=s3://cloud-platform-kops-state/test-etcd-3.cloud-platform.service.justice.gov.uk/backups/etcd/events list-backups

```

Restore the latest backup in the list, or the one containing the timestamp you want to restore from (this will bring the entire cluster back to this point in time). Add a restore command for both main and events as below:


```
etcd-manager-ctl -backup-store=s3://cloud-platform-kops-state/${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk/backups/etcd/main restore-backup 2019-08-27T16:44:23Z-001038

etcd-manager-ctl -backup-store=s3://cloud-platform-kops-state/${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk/backups/etcd/events restore-backup 2019-08-27T16:37:56Z-000351
```

Note that this does not start the restore immediately, to start the restore, you need to roll masters quickly by [rebooting][master-reboot] all the masters from the aws console.

#### Roll masters by rebooting

To reboot all masters, follow below process.

Select all master instances together, and run reboot from actions>instancestate>reboot.

Run the below command to validate the cluster.

```bash
kops validate cluster ${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk
```

All master and worker node should join the cluster, you can see the cluster is in ready status. 

```
Your cluster ${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk is ready
```

Please note that this process might take a short while(around 1 hr), depending on the size of the cluster.

## Integration tests

After the backup restore is completed, run integration tests to verify cluster is working as expected.

## Possible Issues

- After the restore-backup command is run and master nodes are rebooted, you may see the below issues when you run kops validate cluster.

1) If any Master node stuck in "not ready" status, [reboot][master-reboot] that master again, from the aws console.

[kops-repo]: https://github.com/ministryofjustice/cloud-platform-infrastructure/tree/master/kops
[etcd-managet-ctl]: https://github.com/kopeio/etcd-manager/releases/
[create-a-new-cluster]: template-disaster-recovery.html#create-a-new-cluster
[perform-the-restore]: template-disaster-recovery.html#perform-the-restore
[master-reboot]: template-disaster-recovery.html#roll-masters-by-rebooting
[tf-cloud-platform]: https://github.com/ministryofjustice/cloud-platform-infrastructure/tree/master/terraform/cloud-platform
